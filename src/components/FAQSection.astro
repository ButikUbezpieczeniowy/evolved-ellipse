---
// src/components/FAQSection.astro
// Komponent integrujący front-end Astro z Serverless Function Netlify (Gemini API)

export interface FAQItem {
  pytanie: string;
  odpowiedz: string;
}

export interface Props {
  topic: string; // Temat do przekazania do Gemini API (np. "Ubezpieczenie OC i AC")
}

const { topic } = Astro.props;
let faqItems: FAQItem[] = [];
let error: string | null = null;

// WAŻNE: Funkcja asynchroniczna jest wykonywana JEDNOKROTNIE w czasie KOMPILACJI (Build Time)
try {
  // Ścieżka do naszej Netlify Function (została zdefiniowana w folderze netlify/functions)
  // Używamy Astro.site (lub w przypadku środowiska lokalnego Astro.url.origin) do zbudowania poprawnego URL.
  const siteUrl = Astro.site?.href || Astro.url.origin;
  const apiEndpoint = `${siteUrl}.netlify/functions/generate-seo-faq?topic=${encodeURIComponent(topic)}`;
  
  console.log(`[Gemini AI] Wywoływanie funkcji dla tematu: ${topic}`);

  // Wywołanie Serverless Function
  const response = await fetch(apiEndpoint);
  
  if (!response.ok) {
    const errorBody = await response.text();
    throw new Error(`Błąd API: ${response.status} ${response.statusText} - ${errorBody}`);
  }
  
  // Odbieramy ustrukturyzowaną odpowiedź JSON od Gemini
  faqItems = await response.json() as FAQItem[];

} catch (e) {
  error = `Błąd AI podczas generowania FAQ: ${e.message}. Sprawdź, czy klucz GEMINI_API_KEY jest poprawny i czy funkcja netlify/functions/generate-seo-faq.js działa.`;
  console.error(error);
}
---

<section id="faq" class="py-12 bg-gray-50">
    <div class="max-w-4xl mx-auto px-4">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">
            Najczęściej Zadawane Pytania (FAQ)
        </h2>
        
        {faqItems.length === 0 && !error ? (
            <p class="text-center text-gray-500">
                ⚠️ Trwa kompilacja: Sekcja FAQ zostanie wygenerowana przy następnym wdrożeniu lub w tym.
            </p>
        ) : error ? (
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">Błąd Kompilacji AI:</strong>
                <span class="block sm:inline ml-2">{error}</span>
            </div>
        ) : (
            <div class="space-y-4">
                {faqItems.map((item, index) => (
                    <details class="bg-white shadow rounded-lg overflow-hidden border border-gray-200">
                        <summary class="flex justify-between items-center p-5 cursor-pointer list-none font-semibold text-lg text-blue-600">
                            {item.pytanie}
                            <span class="ml-2 transform transition-transform duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </span>
                        </summary>
                        <div class="p-5 pt-0 text-gray-700 border-t border-gray-200">
                            <p>{item.odpowiedz}</p>
                        </div>
                    </details>
                ))}
            </div>
        )}
    </div>
</section>

{faqItems.length > 0 && (
    <script type="application/ld+json" is:inline set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": faqItems.map(item => ({
            "@type": "Question",
            "name": item.pytanie,
            "acceptedAnswer": {
                "@type": "Answer",
                "text": item.odpowiedz
            }
        }))
    })} />
)}