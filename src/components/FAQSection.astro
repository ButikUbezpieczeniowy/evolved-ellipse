---
// src/components/FAQSection.astro
// OSTATECZNA WERSJA POPRAWIONA - Usuwa b≈Çƒôdy typowania i zasiƒôgu.

export interface FAQItem {
  pytanie: string;
  odpowiedz: string;
}

export interface Props {
  topic: string; // Temat do przekazania do Gemini API (np. "Ubezpieczenie OC i AC")
}

const { topic } = Astro.props;
let faqItems: FAQItem[] = [] as FAQItem[]; // Inicjalizacja z poprawnym typem
let error: string | null = null;
let response; 

// WA≈ªNE: Funkcja asynchroniczna jest wykonywana JEDNOKROTNIE w czasie KOMPILACJI (Build Time)
try {
  // U≈ºywamy encodeURIComponent, kt√≥re jest globalnie dostƒôpne w Node.js i jest bezpieczne.
// ...
const encodedTopic = encodeURIComponent(topic);

// üí° Poprawka: U≈ºywamy zmiennej ≈õrodowiskowej Netlify, aby zbudowaƒá PE≈ÅNY, POPRAWNY URL.
// W ≈õrodowisku kompilacji, zmienna URL jest adresem podglƒÖdu (preview)
const baseUrl = process.env.URL || 'https://fallback-url.com'; // Fallback na wypadek braku zmiennej
const apiEndpoint = `${baseUrl}/.netlify/functions/generate-seo-faq?topic=${encodedTopic}`;

console.log(`[Gemini AI] Wywo≈Çywanie funkcji dla tematu: ${topic}`);

// Wywo≈Çanie Serverless Function
response = await fetch(apiEndpoint); 
// ...  
  if (!response.ok) {
    const errorBody = await response.text();
    throw new Error(`B≈ÇƒÖd API: ${response.status} ${response.statusText} - ${errorBody.substring(0, 50)}...`); 
  }
  
  // Odbieramy ustrukturyzowanƒÖ odpowied≈∫ JSON od Gemini
  const data = await response.json();
  
  // Weryfikujemy i rzutujemy typ dla ca≈Çkowitej poprawno≈õci (usuwa b≈ÇƒÖd 'Property map does not exist on type any')
  if (Array.isArray(data)) {
      faqItems = data as FAQItem[];
  } else {
      throw new Error('Otrzymany format danych z API nie jest tablicƒÖ (JSON-array).');
  }

} catch (e) {
  const errorMessage = e instanceof Error ? e.message : 'Nieznany b≈ÇƒÖd.';
  error = `B≈ÇƒÖd AI podczas generowania FAQ: ${errorMessage}. Sprawd≈∫ GEMINI_API_KEY i plik generate-seo-faq.js.`;
  console.error(error);
}
---
<section id="faq" class="py-12 bg-gray-50">
    <div class="max-w-4xl mx-auto px-4">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">
            Najczƒô≈õciej Zadawane Pytania (FAQ)
        </h2>
        
        {/* WARUNKOWE WY≈öWIETLANIE TRE≈öCI / B≈ÅƒòDU */}
        {error ? (
            // WY≈öWIETLAMY B≈ÅƒÑD, JE≈öLI ZOSTA≈Å Z≈ÅAPANY
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">B≈ÇƒÖd Kompilacji AI:</strong>
                <span class="block sm:inline ml-2">{error}</span>
            </div>
        ) : faqItems.length === 0 ? (
            // WY≈öWIETLAMY KOMUNIKAT, JE≈öLI DANYCH BRAK, ALE B≈ÅƒòDU NIE BY≈ÅO (np. po prostu nie wygenerowano lub dane by≈Çy puste)
            <p class="text-center text-gray-500">
                ‚úÖ Kompilacja udana, ale sekcja FAQ jest pusta. Spr√≥buj ponownie lub dostosuj temat.
            </p>
        ) : (
            // RENDERUJEMY LISTƒò FAQ
            <div class="space-y-4">
                {faqItems.map((item) => (
                    <details class="bg-white shadow rounded-lg overflow-hidden border border-gray-200">
                        <summary class="flex justify-between items-center p-5 cursor-pointer list-none font-semibold text-lg text-blue-600">
                            {item.pytanie}
                            <span class="ml-2 transform transition-transform duration-300">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </span>
                        </summary>
                        <div class="p-5 pt-0 text-gray-700 border-t border-gray-200">
                            <p>{item.odpowiedz}</p>
                        </div>
                    </details>
                ))}
            </div>
        )}
    </div>
</section>

{/* Wstrzykniƒôcie JSON-LD dla SEO po udanym pobraniu danych */}
{faqItems.length > 0 && (
    <script type="application/ld+json" is:inline set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": faqItems.map(item => ({
            "@type": "Question",
            "name": item.pytanie,
            "acceptedAnswer": {
                "@type": "Answer",
                "text": item.odpowiedz
            }
        }))
    })} />
)}